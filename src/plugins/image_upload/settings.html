<div class="form-group">
    <div class="form-group">
        <label for="padImage" class="form-label">Scale to Fit:</label>
        <div class="toggle-container">
            <input type="checkbox" id="padImage" name="padImage" class="toggle-checkbox" value="false">
            <label for="padImage" class="toggle-label"></label>
        </div>
        <!-- Hidden input ensures 'true' is always sent when unchecked -->
        <input type="hidden" name="padImage" value="true">
    </div>
    <div class="form-group">
        <label for="randomize" class="form-label">Random Order:</label>
        <div class="toggle-container">
            <input type="checkbox" id="randomize" name="randomize" class="toggle-checkbox" value="false"
                onclick="this.value = this.checked ? 'true' : 'false'">
            <label for="randomize" class="toggle-label"></label>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label" for="backgroundOption">Background:</label>
        <div class="form-group">
            <input type="radio" id="backgroundOption" name="backgroundOption" value="blur">
            <label>Blur</label>
            <input type="radio" id="backgroundOption" name="backgroundOption" value="color">
            <label>Color</label>
            <input type="color" id="backgroundColor" name="backgroundColor" value="#ffffff" class="color-picker"/>
        </div>
    </div>
    <div class="form-group">
        <label class="form-label" for="borderPercent">Border Size: <span id="borderPercentValue">0</span>%</label>
        <input type="range" id="borderPercent" name="borderPercent" min="0" max="10" step="1" value="0" class="form-range"
               oninput="document.getElementById('borderPercentValue').textContent = this.value">
    </div>
</div>

<div class="form-group">
    <label for="imageUpload" class="form-input file-upload-label">Choose Image</label>
    <input type="file" clear-on-submit id="imageUpload" name="imageFiles[]" accept="image/*" multiple
           class="file-upload-input" onchange="addFiles()">
</div>

<!-- Display uploaded & existing file names -->
<div class="form-group">
    <div id="fileNames" class="file-name-list"></div>
</div>

<!-- Hidden input fields to store existing file data -->
<div id="hiddenFileInputs"></div>

<script>
    function addFiles() {
        const fileInput = document.getElementById("imageUpload");
        const fileNamesDisplay = document.getElementById("fileNames");
        
        const files = Array.from(fileInput.files);

        if (!uploadedFiles["imageFiles[]"]) {
            uploadedFiles["imageFiles[]"] = [];
        }

        files.forEach(file => {
            const fileName = file.name;

            // Prevent duplicate files
            if (!uploadedFiles["imageFiles[]"].some(f => f.name === fileName)) {
                uploadedFiles["imageFiles[]"].push(file);

                const fileElement = document.createElement("div");
                fileElement.classList.add("file-name");
                fileElement.setAttribute('delete-on-submit', '');
                fileElement.dataset.fileName = fileName;
                fileElement.dataset.fileType = 'added';

                const span = document.createElement("span");
                span.id = "fileNameText";
                span.textContent = fileName;
                fileElement.appendChild(span);

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "remove-btn";
                removeBtn.textContent = "X";
                removeBtn.addEventListener("click", () => removeAddedFile(fileName, fileElement));
                fileElement.appendChild(removeBtn);

                fileNamesDisplay.appendChild(fileElement);
            }
        });

        // Clear the input to allow adding the same file again if needed
        fileInput.value = "";
    }

    function removeAddedFile(fileName, fileElement) {
        // Remove the file from uploadedFiles
        uploadedFiles["imageFiles[]"] = uploadedFiles["imageFiles[]"].filter(f => f.name !== fileName);

        // Remove the displayed filename
        fileElement.remove();
    }

    function removeExistingFile(fileElement, hiddenInput) {
        fileElement.remove(); // Remove from display
        hiddenInput.remove(); // Remove hidden input
    }

    // populate form values from plugin settings
    document.addEventListener('DOMContentLoaded', () => {    
        const fileNamesDisplay = document.getElementById("fileNames");
        const hiddenFileInputs = document.getElementById("hiddenFileInputs");
        let backgroundOption = "blur"
        if (loadPluginSettings) {
            document.getElementById('padImage').checked = pluginSettings.padImage == 'false';
            document.getElementById('randomize').checked = pluginSettings.randomize;
            document.getElementById('backgroundColor').value = pluginSettings.backgroundColor;
            const borderPercent = pluginSettings.borderPercent || 0;
            document.getElementById('borderPercent').value = borderPercent;
            document.getElementById('borderPercentValue').textContent = borderPercent;

            const existingFiles = pluginSettings['imageFiles[]'] || []
            backgroundOption = pluginSettings.backgroundOption || 'blur'

            // Loop through the existing files and add them to the display and hidden inputs
            existingFiles.forEach(filePath => {
                const fileName = filePath.split('/').pop();

                // Create a hidden input for the existing file
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "imageFiles[]";
                hiddenInput.value = filePath;
                hiddenInput.setAttribute('delete-on-submit', '');
                hiddenFileInputs.appendChild(hiddenInput);

                // Create an element for the file name
                const fileElement = document.createElement("div");
                fileElement.classList.add("file-name");
                fileElement.setAttribute('delete-on-submit', '');

                const span = document.createElement("span");
                span.id = "fileNameText";
                span.textContent = fileName;
                fileElement.appendChild(span);

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "remove-btn";
                removeBtn.textContent = "X";
                removeBtn.addEventListener("click", () => removeExistingFile(fileElement, hiddenInput));
                fileElement.appendChild(removeBtn);

                fileNamesDisplay.appendChild(fileElement);
            });
        }
        document.querySelector(`input[name="backgroundOption"][value="${backgroundOption}"]`).checked = true;
    });
</script>
